<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETFæŒè‚¡åˆ†æå¹³å° Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
* {margin: 0; padding: 0; box-sizing: border-box;}
body {font-family: 'Segoe UI', Tahoma; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); color: #333; min-height: 100vh;}

.gradient-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 40px 20px;
    text-align: center;
    margin-bottom: 30px;
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
}

.gradient-header h1 {font-size: 32px; font-weight: 700; margin-bottom: 12px;}
.gradient-header p {font-size: 13px; opacity: 0.9; margin: 5px 0;}

.container {max-width: 1400px; margin: 0 auto; padding: 0 20px;}

.tabs-container {
    background: white;
    border-bottom: 3px solid #667eea;
    margin-bottom: 25px;
    border-radius: 8px 8px 0 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.tabs {display: flex; padding: 0;}
.tab-btn {flex: 0 1 150px; padding: 15px 20px; background: none; border: none; cursor: pointer; color: #888; font-size: 15px; border-bottom: 3px solid transparent; transition: all 0.3s;}
.tab-btn:hover {color: #546ded;}
.tab-btn.active {color: white; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-bottom-color: white;}

.content-box {background: white; border-radius: 8px; padding: 25px; box-shadow: 0 4px 16px rgba(0,0,0,0.08);}

.etf-tabs {display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; flex-wrap: wrap;}
.etf-tab {background: none; border: none; cursor: pointer; color: #888; font-size: 14px; padding: 8px 15px; border-bottom: 3px solid transparent; transition: all 0.2s; font-weight: 500;}
.etf-tab:hover {color: #546ded;}
.etf-tab.active {color: #667eea; border-bottom-color: #667eea; font-weight: 600;}

.etf-price-box {background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-radius: 12px; padding: 20px; margin-bottom: 25px; border-left: 5px solid #667eea;}
.etf-price-code {font-size: 18px; font-weight: 700; color: #667eea;}
.etf-price-name {font-size: 12px; color: #999; margin-top: 3px;}
.etf-price-value {font-size: 32px; font-weight: 700; color: #222; margin-top: 10px;}
.etf-price-change {font-size: 14px; margin-top: 8px; font-weight: 600;}
.etf-price-change.negative {color: #e74c3c;}
.etf-price-change.positive {color: #27ae60;}

.changes-grid {display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px;}

.change-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid #f0f0f0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    position: relative;
    overflow: hidden;
}

.change-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    height: 4px;
    width: 100%;
    background: linear-gradient(90deg, #546ded, #764ba2);
    transition: height 0.3s;
}

.change-card:hover {
    box-shadow: 0 12px 32px rgba(84, 110, 237, 0.2);
    transform: translateY(-8px);
    border-color: #667eea;
}

.change-card:hover::before {height: 6px;}

/* æ–°å¢ç‹€æ…‹ - ç¶ è‰²ç™¼å…‰ */
.change-card.new-add {
    border: 2px solid #27ae60;
    background: linear-gradient(135deg, rgba(39,174,96,0.05) 0%, rgba(39,174,96,0.02) 100%);
}

.change-card.new-add::before {background: linear-gradient(90deg, #27ae60, #16a34a);}

.change-card.new-add:hover {
    box-shadow: 0 12px 32px rgba(39, 174, 96, 0.25);
    background: linear-gradient(135deg, rgba(39,174,96,0.1) 0%, rgba(39,174,96,0.05) 100%);
}

/* åˆªé™¤ç‹€æ…‹ - ç´…è‰²ç™¼å…‰ */
.change-card.delete {
    border: 2px solid #e74c3c;
    background: linear-gradient(135deg, rgba(231,76,60,0.05) 0%, rgba(231,76,60,0.02) 100%);
}

.change-card.delete::before {background: linear-gradient(90deg, #e74c3c, #c0392b);}

.change-card.delete:hover {
    box-shadow: 0 12px 32px rgba(231, 76, 60, 0.25);
    background: linear-gradient(135deg, rgba(231,76,60,0.1) 0%, rgba(231,76,60,0.05) 100%);
}

.change-card-header {display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #f0f0f0;}
.change-code-name {flex: 1;}
.change-code {font-size: 20px; font-weight: 700; color: #222;}
.change-name {font-size: 13px; color: #999; margin-top: 2px; font-weight: 500;}

.badge {display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 700;}
.badge.new {background: linear-gradient(135deg, #27ae60, #16a34a); color: white; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3); animation: pulse 2s infinite;}
.badge.add {background: #d1ecf1; color: #0c5460;}
.badge.reduce {background: #f8d7da; color: #721c24;}
.badge.delete {background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3); animation: pulse 2s infinite;}

@keyframes pulse {0%, 100% {box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);} 50% {box-shadow: 0 4px 20px rgba(39, 174, 96, 0.6);}}

.badge-icon {font-size: 16px;}

.change-stats {display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-bottom: 14px;}
.stat-item {background: #f9fbfc; padding: 14px; border-radius: 8px; border-left: 3px solid #667eea;}
.stat-label {font-size: 11px; color: #999; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px;}
.stat-value {font-size: 16px; font-weight: 700; color: #222;}
.stat-value.positive {color: #27ae60;}
.stat-value.negative {color: #e74c3c;}

.change-indicator {
    display: flex;
    gap: 3px;
    padding: 2px 0;
}

.change-indicator span {
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: #e0e0e0;
}

.change-indicator span.active {background: #667eea;}

.search-box {margin-bottom: 20px;}
.search-box input {width: 100%; padding: 14px 16px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; transition: all 0.2s;}
.search-box input:focus {border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); outline: none;}

.stocks-grid {display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 18px;}

.stock-card {
    background: white;
    border-radius: 12px;
    padding: 18px;
    border: 2px solid #f0f0f0;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.stock-card:hover {
    box-shadow: 0 12px 32px rgba(84, 110, 237, 0.15);
    transform: translateY(-6px);
    border-color: #667eea;
}

.stock-card-header {margin-bottom: 14px; padding-bottom: 12px; border-bottom: 1px solid #f0f0f0;}
.stock-code {font-size: 18px; font-weight: 700; color: #667eea;}
.stock-name {font-size: 14px; color: #333; margin-top: 4px; font-weight: 500;}

.stock-stats {display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 13px;}
.stock-stat {background: #f9fbfc; padding: 12px; border-radius: 6px; border-left: 3px solid #667eea;}
.stock-stat-label {color: #999; margin-bottom: 4px; font-size: 11px;}
.stock-stat-value {font-size: 15px; font-weight: 700; color: #222;}

.hidden {display: none;}
.detail-page {display: none;}
.detail-page.active {display: block;}

.back-btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 20px;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.back-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.stock-header {
    background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    margin-bottom: 25px;
    border-left: 5px solid #667eea;
}

.stock-title {font-size: 24px; font-weight: 700; margin-bottom: 18px; color: #222;}

.stats-row {display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 18px; margin-bottom: 20px;}

.stat-box {background: white; padding: 18px; border-radius: 12px; text-align: center; border: 2px solid #f0f0f0; transition: all 0.2s;}
.stat-box:hover {border-color: #667eea; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);}
.stat-box-value {font-size: 24px; font-weight: 700; color: #667eea;}
.stat-box-label {font-size: 12px; color: #999; margin-top: 6px; text-transform: uppercase; letter-spacing: 0.5px;}

.chart-container {background: white; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 2px solid #f0f0f0;}
.chart-container h3 {font-size: 16px; font-weight: 700; margin-bottom: 15px; color: #222;}

.history-table {background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 2px solid #f0f0f0;}
table {width: 100%; border-collapse: collapse;}
th {background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 14px; text-align: left; font-weight: 700; font-size: 12px; color: #333; border-bottom: 2px solid #e0e0e0; text-transform: uppercase; letter-spacing: 0.5px;}
td {padding: 14px; border-bottom: 1px solid #f0f0f0; font-size: 13px;}
tbody tr {transition: all 0.2s;}
tbody tr:hover {background: linear-gradient(90deg, #667eea05 0%, #764ba205 100%); box-shadow: inset 0 0 10px rgba(102, 126, 234, 0.1);}

.row-highlight {background: linear-gradient(90deg, rgba(39,174,96,0.1) 0%, rgba(39,174,96,0.05) 100%);}
.row-highlight:hover {background: linear-gradient(90deg, rgba(39,174,96,0.2) 0%, rgba(39,174,96,0.15) 100%);}

.row-delete {background: linear-gradient(90deg, rgba(231,76,60,0.1) 0%, rgba(231,76,60,0.05) 100%);}
.row-delete:hover {background: linear-gradient(90deg, rgba(231,76,60,0.2) 0%, rgba(231,76,60,0.15) 100%);}

.status-badge {display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;}
.status-new {background: #d4edda; color: #155724;}
.status-delete {background: #f8d7da; color: #721c24;}
.status-add {background: #d1ecf1; color: #0c5460;}
.status-reduce {background: #f8d7da; color: #721c24;}

.no-data {color: #999; text-align: center; padding: 30px; font-size: 14px;}
    </style>
</head>
<body>

<div class="gradient-header">
    <h1>ğŸš€ ETFæŒè‚¡åˆ†æå¹³å° Pro</h1>
    <p id="updateTime">æœ€æ–°æ›´æ–°: 2025/11/07</p>
    <p>å¯¦æ™‚ç•°å‹•ç›£æ§ â€¢ æ™ºèƒ½æŒè‚¡åˆ†æ â€¢ å®Œæ•´æ­·å²è¿½è¹¤</p>
</div>

<div class="container">
    <div class="tabs-container">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchMode('changes')">ğŸ“Š ç•°å‹•æ˜ç´°</button>
            <button class="tab-btn" onclick="switchMode('search')">ğŸ” è‚¡ç¥¨æŸ¥è©¢</button>
        </div>
    </div>

    <!-- ç•°å‹•æ˜ç´°æ¨¡å¼ -->
    <div id="changesMode" class="content-box">
        <div class="etf-tabs">
            <button class="etf-tab active" onclick="switchETF('00981A')">00981A çµ±ä¸€å°è‚¡å¢é•·</button>
            <button class="etf-tab" onclick="switchETF('00980A')">00980A é‡æ‘æ™ºæ…§å„ªé¸</button>
            <button class="etf-tab" onclick="switchETF('00982A')">00982A ç¾¤ç›Šå¼·æ£’</button>
        </div>
        <div id="etfPriceInfo"></div>
        <div id="changesGrid" class="changes-grid"></div>
    </div>

    <!-- è‚¡ç¥¨æŸ¥è©¢æ¨¡å¼ -->
    <div id="searchMode" class="content-box hidden">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±... ä¾‹å¦‚: 2330ã€å°ç©é›»">
        </div>
        <div class="stocks-grid" id="stocksList"></div>
    </div>

    <!-- è©³ç´°é é¢ -->
    <div id="detailPage" class="detail-page">
        <button class="back-btn" onclick="backToMode()">â† è¿”å›</button>
        <div class="stock-header">
            <div class="stock-title" id="detailTitle"></div>
            <div class="stats-row" id="statsContainer"></div>
        </div>
        <div id="etfTabsDetail" style="margin-bottom: 25px;"></div>
        <div class="chart-container" id="chartContainer" style="display:none;">
            <h3>ğŸ“ˆ æŒè‚¡è¶¨å‹¢åœ–</h3>
            <canvas id="trendChart" style="max-height: 300px;"></canvas>
        </div>
        <div class="history-table">
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>ğŸ“… æ—¥æœŸ</th>
                        <th>ğŸ“Š æŒè‚¡(å¼µ)</th>
                        <th>ğŸ’¯ æ¬Šé‡(%)</th>
                        <th>ğŸ“ˆ å¼µæ•¸è®Šå‹•</th>
                        <th>ğŸ“Š æ¬Šé‡è®Šå‹•</th>
                        <th>ğŸ·ï¸ ç‹€æ…‹</th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
let stockData = {};
let processedData = {};
let currentETF = '00981A';
let currentMode = 'changes';
let currentStock = null;
let detailETF = null;
let trendChart = null;

function switchMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.tab-btn').forEach((btn, idx) => {
        btn.classList.toggle('active', (idx === 0 && mode === 'changes') || (idx === 1 && mode === 'search'));
    });
    
    if (mode === 'changes') {
        document.getElementById('changesMode').classList.remove('hidden');
        document.getElementById('searchMode').classList.add('hidden');
        document.getElementById('detailPage').classList.remove('active');
    } else {
        document.getElementById('changesMode').classList.add('hidden');
        document.getElementById('searchMode').classList.remove('hidden');
        document.getElementById('detailPage').classList.remove('active');
        renderStockList(Object.values(stockData));
    }
}

function switchETF(code) {
    currentETF = code;
    document.querySelectorAll('.etf-tab').forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    renderChanges();
}

function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function renderChanges() {
    const data = processedData[currentETF];
    if (!data) return;
    
    document.getElementById('etfPriceInfo').innerHTML = `
        <div class="etf-price-box">
            <div class="etf-price-code">${currentETF}</div>
            <div class="etf-price-name">${data.name}</div>
            <div class="etf-price-value">$${data.price}</div>
            <div class="etf-price-change ${parseFloat(data.change_value) < 0 ? 'negative' : 'positive'}">
                ${parseFloat(data.change_value) >= 0 ? 'ğŸ“ˆ â–²' : 'ğŸ“‰ â–¼'} ${data.change_value} (${data.change_percent})
            </div>
        </div>
    `;
    
    const grid = document.getElementById('changesGrid');
    grid.innerHTML = '';
    
    if (!data.daily_changes || data.daily_changes.length === 0) {
        grid.innerHTML = '<p class="no-data">ä»Šæ—¥ç„¡ç•°å‹•è³‡æ–™</p>';
        return;
    }
    
    data.daily_changes.forEach(change => {
        const badgeClass = change.type === 'æ–°å¢' ? 'new' : change.type === 'å¢æŒ' ? 'add' : change.type === 'æ¸›æŒ' ? 'reduce' : 'delete';
        const cardClass = change.type === 'æ–°å¢' ? 'new-add' : change.type === 'åˆªé™¤' ? 'delete' : '';
        const badgeIcon = change.type === 'æ–°å¢' ? 'âœ¨' : change.type === 'åˆªé™¤' ? 'ğŸ—‘ï¸' : change.type === 'å¢æŒ' ? 'ğŸ“ˆ' : 'ğŸ“‰';
        
        const countChangeStr = change.count_change >= 0 ? '+' : '';
        const weightChangeStr = change.weight_change >= 0 ? '+' : '';
        
        const card = document.createElement('div');
        card.className = `change-card ${cardClass}`;
        card.onclick = () => showStockDetail(change.code, currentETF);
        
        card.innerHTML = `
            <div class="change-card-header">
                <div class="change-code-name">
                    <div class="change-code">${change.code}</div>
                    <div class="change-name">${change.name}</div>
                </div>
                <span class="badge ${badgeClass}"><span class="badge-icon">${badgeIcon}</span>${change.type}</span>
            </div>
            
            <div class="change-stats">
                <div class="stat-item">
                    <div class="stat-label">ğŸ’¼ ä»Šæ—¥æŒè‚¡</div>
                    <div class="stat-value">${formatNumber(change.current_count)}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ğŸ’¯ ä»Šæ—¥æ¬Šé‡</div>
                    <div class="stat-value">${change.current_weight.toFixed(2)}%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ğŸ“Š å¼µæ•¸è®Šå‹•</div>
                    <div class="stat-value ${change.count_change > 0 ? 'positive' : 'negative'}">
                        ${countChangeStr}${formatNumber(change.count_change)}
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ğŸ“ˆ æ¬Šé‡è®Šå‹•</div>
                    <div class="stat-value ${change.weight_change > 0 ? 'positive' : 'negative'}">
                        ${weightChangeStr}${change.weight_change.toFixed(2)}%
                    </div>
                </div>
            </div>
        `;
        grid.appendChild(card);
    });
}

function renderStockList(stocks) {
    const list = document.getElementById('stocksList');
    list.innerHTML = '';
    if (stocks.length === 0) {
        list.innerHTML = '<p class="no-data">æš«ç„¡è‚¡ç¥¨æ•¸æ“š</p>';
        return;
    }
    stocks.slice(0, 200).forEach(stock => {
        const firstETF = Object.keys(stock.etf_holdings)[0];
        const etfCount = Object.keys(stock.etf_holdings).length;
        const totalCount = Object.values(stock.etf_holdings).reduce((sum, etf) => sum + (etf.current_count || 0), 0);
        
        const card = document.createElement('div');
        card.className = 'stock-card';
        card.onclick = () => showStockDetail(stock.code, firstETF);
        
        card.innerHTML = `
            <div class="stock-card-header">
                <div class="stock-code">${stock.code}</div>
                <div class="stock-name">${stock.name || '(ç„¡åç¨±)'}</div>
            </div>
            <div class="stock-stats">
                <div class="stock-stat">
                    <div class="stock-stat-label">æŒæœ‰ETF</div>
                    <div class="stock-stat-value">${etfCount}</div>
                </div>
                <div class="stock-stat">
                    <div class="stock-stat-label">ç¸½æŒè‚¡</div>
                    <div class="stock-stat-value">${formatNumber(totalCount)}</div>
                </div>
            </div>
        `;
        list.appendChild(card);
    });
}

function showStockDetail(stockCode, etfCode) {
    if (!stockData[stockCode]) return;
    
    currentStock = stockCode;
    detailETF = etfCode;
    const stock = stockData[stockCode];
    
    document.getElementById('changesMode').classList.add('hidden');
    document.getElementById('searchMode').classList.add('hidden');
    document.getElementById('detailPage').classList.add('active');
    
    document.getElementById('detailTitle').textContent = `ğŸ“ ${stock.code} ${stock.name || ''}`;
    
    const etfCount = Object.keys(stock.etf_holdings).length;
    const totalCount = Object.values(stock.etf_holdings).reduce((sum, etf) => sum + (etf.current_count || 0), 0);
    const maxCount = Math.max(...Object.values(stock.etf_holdings).map(e => e.max_count || 0));
    const minCount = Math.min(...Object.values(stock.etf_holdings).map(e => e.min_count || Infinity).filter(v => v !== Infinity));
    
    document.getElementById('statsContainer').innerHTML = `
        <div class="stat-box"><div class="stat-box-value">${etfCount}</div><div class="stat-box-label">æŒæœ‰ETF</div></div>
        <div class="stat-box"><div class="stat-box-value">${formatNumber(totalCount)}</div><div class="stat-box-label">ç•¶å‰ç¸½æŒè‚¡</div></div>
        <div class="stat-box"><div class="stat-box-value">${formatNumber(maxCount)}</div><div class="stat-box-label">æœ€é«˜æŒè‚¡</div></div>
        <div class="stat-box"><div class="stat-box-value">${formatNumber(minCount)}</div><div class="stat-box-label">æœ€ä½æŒè‚¡</div></div>
    `;
    
    const tabsDetail = document.getElementById('etfTabsDetail');
    tabsDetail.innerHTML = '';
    Object.entries(stock.etf_holdings).forEach(([etfCode, etfData]) => {
        const btn = document.createElement('button');
        btn.className = 'etf-tab' + (detailETF === etfCode ? ' active' : '');
        btn.textContent = `${etfCode} ${etfData.etf_name}`;
        btn.onclick = () => switchDetailETF(etfCode);
        tabsDetail.appendChild(btn);
    });
    
    renderHistoryTable(etfCode);
}

function switchDetailETF(etfCode) {
    detailETF = etfCode;
    document.querySelectorAll('#etfTabsDetail .etf-tab').forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    renderHistoryTable(etfCode);
}

function renderHistoryTable(etfCode) {
    const stock = stockData[currentStock];
    const etfData = stock.etf_holdings[etfCode];
    
    if (!etfData || !etfData.history) {
        document.getElementById('historyBody').innerHTML = '<tr><td colspan="6" class="no-data">æš«ç„¡æ­·å²æ•¸æ“š</td></tr>';
        return;
    }
    
    let html = '';
    const sortedHistory = [...etfData.history].sort((a, b) => {
        return new Date(b.date.replace(/\//g, '-')) - new Date(a.date.replace(/\//g, '-'));
    });
    
    // ç¹ªè£½è¶¨å‹¢åœ–
    drawTrendChart(sortedHistory);
    
    sortedHistory.forEach(record => {
        const changeClass = record.count_change > 0 ? 'positive' : record.count_change < 0 ? 'negative' : '';
        const rowClass = record.status === 'å‡ºæ¸…' ? 'row-delete' : record.status === 'é¦–æ¬¡å‡ºç¾' ? 'row-highlight' : '';
        const countStr = record.count_change >= 0 ? '+' : '';
        const weightStr = record.weight_change >= 0 ? '+' : '';
        const statusBadge = `<span class="status-badge status-${record.status === 'å‡ºæ¸…' ? 'delete' : record.status === 'é¦–æ¬¡å‡ºç¾' ? 'new' : record.status === 'å¢æŒ' ? 'add' : 'reduce'}">${record.status}</span>`;
        
        html += `<tr class="${rowClass}">
            <td>${record.date}</td>
            <td><strong>${formatNumber(record.count)}</strong></td>
            <td>${record.weight.toFixed(2)}%</td>
            <td class="${changeClass}"><strong>${countStr}${formatNumber(record.count_change)}</strong></td>
            <td class="${changeClass}"><strong>${weightStr}${record.weight_change.toFixed(2)}%</strong></td>
            <td>${statusBadge}</td>
        </tr>`;
    });
    
    document.getElementById('historyBody').innerHTML = html;
}

function drawTrendChart(history) {
    const chartContainer = document.getElementById('chartContainer');
    chartContainer.style.display = 'block';
    
    const sortedHistory = [...history].sort((a, b) => {
        return new Date(a.date.replace(/\//g, '-')) - new Date(b.date.replace(/\//g, '-'));
    });
    
    const labels = sortedHistory.map(h => h.date);
    const counts = sortedHistory.map(h => h.count);
    
    const ctx = document.getElementById('trendChart').getContext('2d');
    
    if (trendChart) {
        trendChart.destroy();
    }
    
    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'æŒè‚¡å¼µæ•¸',
                data: counts,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#667eea',
                pointBorderColor: 'white',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {legend: {display: false}},
            scales: {y: {beginAtZero: false, grid: {color: 'rgba(0,0,0,0.05)'}}},
        }
    });
}

function backToMode() {
    if (currentMode === 'changes') {
        document.getElementById('detailPage').classList.remove('active');
        document.getElementById('changesMode').classList.remove('hidden');
    } else {
        document.getElementById('detailPage').classList.remove('active');
        document.getElementById('searchMode').classList.remove('hidden');
    }
    currentStock = null;
    detailETF = null;
}

document.addEventListener('DOMContentLoaded', () => {
    Promise.all([
        fetch('./processed_etf_data.json').then(r => r.json()),
        fetch('./stock_history_data.json').then(r => r.json())
    ]).then(([pdata, sdata]) => {
        processedData = pdata;
        stockData = sdata;
        
        let first = processedData[Object.keys(processedData)[0]];
        if(first && first.latest_date){
            document.getElementById('updateTime').textContent = 'æœ€æ–°æ›´æ–°: ' + first.latest_date;
        }
        
        renderChanges();
        
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const filtered = Object.values(stockData).filter(stock =>
                stock.code.includes(keyword) || (stock.name && stock.name.toLowerCase().includes(keyword))
            );
            renderStockList(filtered);
        });
    }).catch(e => {
        console.error('è¼‰å…¥éŒ¯èª¤:', e);
        alert('ç„¡æ³•è¼‰å…¥è³‡æ–™æª”æ¡ˆï¼Œè«‹ç¢ºä¿ processed_etf_data.json å’Œ stock_history_data.json åœ¨åŒç›®éŒ„');
    });
});
</script>

</body>
</html>
