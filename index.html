<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETFæŒè‚¡åˆ†æå¹³å°</title>
    <style>
* {margin: 0; padding: 0; box-sizing: border-box;}
body {font-family: 'Segoe UI', Tahoma; background: #f9fbfc; color: #333;}
.header {background: white; border-bottom: 3px solid #546ded; padding: 25px 0; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
.header-content {max-width: 1200px; margin: 0 auto; padding: 0 20px;}
.header h1 {font-size: 22px; font-weight: 600; margin-bottom: 12px; color: #222;}
.header .subtitle {font-size: 13px; color: #666; display: flex; align-items: center; gap: 6px;}
.header .subtitle .icon {font-size: 15px;}
.container {max-width: 1200px; margin: 0 auto; padding: 0 20px;}

.tabs-section {background: white; border-radius: 8px; padding: 0; margin-bottom: 25px; box-shadow: 0 1px 4px rgba(0,0,0,0.08);}
.tabs {display: flex; border-bottom: 1px solid #eee;}
.tab-btn {flex: 1; padding: 15px 20px; text-align: center; background: none; border: none; cursor: pointer; color: #888; font-size: 14px; border-bottom: 3px solid transparent; transition: all 0.2s;}
.tab-btn:hover {color: #546ded;}
.tab-btn.active {color: #546ded; border-bottom-color: #546ded;}

.content-section {background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.08);}
.search-box {margin-bottom: 20px;}
.search-box input {width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;}

.etf-price-info {background: #f5f7fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;}
.etf-price-box {background: white; padding: 15px; border-radius: 6px;}
.etf-price-code {font-size: 18px; font-weight: bold; color: #546ded;}
.etf-price-name {font-size: 12px; color: #888; margin-top: 3px;}
.etf-price-value {font-size: 24px; font-weight: bold; color: #222; margin-top: 8px;}
.etf-price-change {font-size: 14px; margin-top: 5px;}
.etf-price-change.negative {color: #e74c3c;}
.etf-price-change.positive {color: #27ae60;}

.changes-grid {display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 18px;}
.change-card {background: white; border-left: 4px solid #546ded; border-radius: 6px; padding: 16px; cursor: pointer; transition: all 0.2s; border: 1px solid #f0f0f0;}
.change-card:hover {box-shadow: 0 4px 12px rgba(84, 110, 237, 0.15); transform: translateY(-2px);}
.change-card-header {display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;}
.change-code {font-size: 18px; font-weight: bold; color: #222;}
.change-name {font-size: 12px; color: #888; margin-top: 2px;}
.badge {display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;}
.badge.new {background: #d4edda; color: #155724;}
.badge.add {background: #d1ecf1; color: #0c5460;}
.badge.reduce {background: #f8d7da; color: #721c24;}
.change-stats {display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 12px;}
.stat {background: #f9fbfc; padding: 10px; border-radius: 4px;}
.stat-label {font-size: 11px; color: #999;}
.stat-value {font-size: 13px; font-weight: bold; color: #222; margin-top: 4px;}
.stat-value.positive {color: #27ae60;}
.stat-value.negative {color: #e74c3c;}

.stocks-list {background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.08);}
.stock-item {padding: 15px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s;}
.stock-item:hover {background: #f9fbfc;}
.stock-code {font-size: 16px; font-weight: bold; color: #546ded;}
.stock-name {font-size: 12px; color: #888; margin-top: 3px;}

.detail-page {display: none;}
.detail-page.active {display: block;}
.back-btn {background: #546ded; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-bottom: 20px; font-size: 14px;}
.back-btn:hover {background: #4a59c4;}

.stock-header {background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); margin-bottom: 20px;}
.stock-title {font-size: 22px; font-weight: bold; margin-bottom: 15px;}
.stats-row {display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;}
.stat-box {background: #f5f7fa; padding: 15px; border-radius: 6px; text-align: center;}
.stat-box-value {font-size: 20px; font-weight: bold; color: #546ded;}
.stat-box-label {font-size: 12px; color: #888; margin-top: 5px;}

.history-table {background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.08);}
table {width: 100%; border-collapse: collapse;}
th {background: #f5f7fa; padding: 12px; text-align: left; font-weight: 600; font-size: 12px; color: #333; border-bottom: 1px solid #eee;}
td {padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 13px;}
tr:hover {background: #fafbfc;}

.hidden {display: none;}
    </style>
</head>
<body>
<div class="header">
    <div class="header-content">
        <h1>ğŸ›ï¸ ETF ä»Šæ—¥è®Šå‹•</h1>
        <div class="subtitle">
            <span class="icon">ğŸ“Š</span>
            <span>æœ€æ–°ç•°å‹•è‚¡ç¥¨æ˜ç´°</span>
        </div>
    </div>
</div>

<div class="container">
    <div class="tabs-section">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchMode('changes')">ç•°å‹•æ˜ç´°</button>
            <button class="tab-btn" onclick="switchMode('search')">è‚¡ç¥¨æŸ¥è©¢</button>
        </div>
    </div>

    <!-- ç•°å‹•æ˜ç´°æ¨¡å¼ -->
    <div id="changesMode" class="content-section">
        <div style="margin-bottom: 20px;">
            <div style="display: flex; gap: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                <button onclick="switchETF('00981A')" class="etf-tab active">00981A çµ±ä¸€å°è‚¡å¢é•·</button>
                <button onclick="switchETF('00980A')" class="etf-tab">00980A é‡æ‘æ™ºæ…§å„ªé¸</button>
                <button onclick="switchETF('00982A')" class="etf-tab">00982A ç¾¤ç›Šå¼·æ£’</button>
            </div>
        </div>
        <div id="etfPriceInfo"></div>
        <div id="changesGrid" class="changes-grid"></div>
    </div>

    <!-- è‚¡ç¥¨æŸ¥è©¢æ¨¡å¼ -->
    <div id="searchMode" class="content-section hidden">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="æœå°‹è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±... ä¾‹å¦‚: 2330ã€å°ç©é›»">
        </div>
        <div class="stocks-list" id="stocksList"></div>
    </div>

    <!-- è©³ç´°é é¢ -->
    <div id="detailPage" class="detail-page">
        <button class="back-btn" onclick="backToMode()">â† è¿”å›</button>
        <div class="stock-header">
            <div class="stock-title" id="detailTitle"></div>
            <div class="stats-row" id="statsContainer"></div>
        </div>
        <div class="history-table">
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>æŒè‚¡(å¼µ)</th>
                        <th>æ¬Šé‡(%)</th>
                        <th>å¼µæ•¸è®Šå‹•</th>
                        <th>æ¬Šé‡è®Šå‹•</th>
                        <th>ç‹€æ…‹</th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>
</div>

<style>
.etf-tab {background: none; border: none; cursor: pointer; color: #888; font-size: 14px; padding: 8px 15px; border-bottom: 2px solid transparent; transition: all 0.2s;}
.etf-tab:hover {color: #546ded;}
.etf-tab.active {color: #546ded; border-bottom-color: #546ded;}
</style>

<script>
let stockData = {};
let processedData = {};
let currentETF = '00981A';
let currentMode = 'changes';
let currentStock = null;

function switchMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.tab-btn').forEach((btn, idx) => {
        btn.classList.toggle('active', (idx === 0 && mode === 'changes') || (idx === 1 && mode === 'search'));
    });
    
    if (mode === 'changes') {
        document.getElementById('changesMode').classList.remove('hidden');
        document.getElementById('searchMode').classList.add('hidden');
        document.getElementById('detailPage').classList.remove('active');
    } else {
        document.getElementById('changesMode').classList.add('hidden');
        document.getElementById('searchMode').classList.remove('hidden');
        document.getElementById('detailPage').classList.remove('active');
        renderStockList(Object.values(stockData));
    }
}

function switchETF(code) {
    currentETF = code;
    document.querySelectorAll('.etf-tab').forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    renderChanges();
}

function renderChanges() {
    const data = processedData[currentETF];
    if (!data) return;
    
    // é¡¯ç¤ºETFåƒ¹æ ¼è³‡è¨Š
    document.getElementById('etfPriceInfo').innerHTML = `
        <div style="display: flex; gap: 15px;">
            <div style="flex: 1; background: #f5f7fa; border-radius: 8px; padding: 15px;">
                <div style="font-size: 18px; font-weight: bold; color: #222;">${currentETF}</div>
                <div style="font-size: 12px; color: #888; margin-top: 2px;">${data.name}</div>
                <div style="font-size: 24px; font-weight: bold; color: #222; margin-top: 10px;">$${data.price}</div>
                <div style="font-size: 14px; color: ${parseFloat(data.change_value) < 0 ? '#e74c3c' : '#27ae60'}; margin-top: 5px;">
                    ${parseFloat(data.change_value) >= 0 ? 'â–²' : 'â–¼'} ${data.change_value} (${data.change_percent})
                </div>
            </div>
        </div>
    `;
    
    const grid = document.getElementById('changesGrid');
    grid.innerHTML = '';
    
    if (!data.daily_changes || data.daily_changes.length === 0) {
        grid.innerHTML = '<p style="color:#999;grid-column:1/-1;">ä»Šæ—¥ç„¡ç•°å‹•è³‡æ–™</p>';
        return;
    }
    
    data.daily_changes.forEach(change => {
        const badgeClass = change.type === 'æ–°å¢' ? 'new' : change.type === 'å¢æŒ' ? 'add' : 'reduce';
        const card = document.createElement('div');
        card.className = 'change-card';
        card.onclick = () => showStockDetail(change.code);
        card.innerHTML = `
            <div class="change-card-header">
                <div>
                    <div class="change-code">${change.code}</div>
                    <div class="change-name">${change.name}</div>
                </div>
                <span class="badge ${badgeClass}">${change.type}</span>
            </div>
            <div class="change-stats">
                <div class="stat">
                    <div class="stat-label">ä»Šæ—¥æŒè‚¡</div>
                    <div class="stat-value">${(change.current_count / 1000).toLocaleString('zh-TW', {maximumFractionDigits: 0})}K</div>
                </div>
                <div class="stat">
                    <div class="stat-label">ä»Šæ—¥æ¬Šé‡</div>
                    <div class="stat-value">${change.current_weight.toFixed(2)}%</div>
                </div>
                <div class="stat">
                    <div class="stat-label">å¼µæ•¸è®Šå‹•</div>
                    <div class="stat-value ${change.count_change > 0 ? 'positive' : 'negative'}">
                        ${change.count_change > 0 ? '+' : ''}${(change.count_change / 1000).toLocaleString('zh-TW', {maximumFractionDigits: 0})}K
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">æ¬Šé‡è®Šå‹•</div>
                    <div class="stat-value ${change.weight_change > 0 ? 'positive' : 'negative'}">
                        ${change.weight_change > 0 ? '+' : ''}${change.weight_change.toFixed(2)}%
                    </div>
                </div>
            </div>
        `;
        grid.appendChild(card);
    });
}

function renderStockList(stocks) {
    const list = document.getElementById('stocksList');
    list.innerHTML = '';
    if (stocks.length === 0) {
        list.innerHTML = '<p style="padding:20px;color:#999;text-align:center;">æš«ç„¡è‚¡ç¥¨æ•¸æ“š</p>';
        return;
    }
    stocks.slice(0, 100).forEach(stock => {
        const item = document.createElement('div');
        item.className = 'stock-item';
        item.onclick = () => showStockDetail(stock.code);
        item.innerHTML = `
            <div class="stock-code">${stock.code}</div>
            <div class="stock-name">${stock.name || ""}</div>
        `;
        list.appendChild(item);
    });
}

function showStockDetail(stockCode) {
    if (!stockData[stockCode]) return;
    currentStock = stockCode;
    const stock = stockData[stockCode];
    document.getElementById('changesMode').classList.add('hidden');
    document.getElementById('searchMode').classList.add('hidden');
    document.getElementById('detailPage').classList.add('active');
    
    document.getElementById('detailTitle').textContent = `${stock.code} ${stock.name || ""}`;
    const etfCount = Object.keys(stock.etf_holdings).length;
    const totalCount = Object.values(stock.etf_holdings).reduce((sum, etf) => sum + (etf.current_count || 0), 0);
    document.getElementById('statsContainer').innerHTML = `
        <div class="stat-box"><div class="stat-box-value">${etfCount}</div><div class="stat-box-label">æŒæœ‰ETFæ•¸é‡</div></div>
        <div class="stat-box"><div class="stat-box-value">${(totalCount / 1000).toLocaleString('zh-TW', {maximumFractionDigits: 1})}K</div><div class="stat-box-label">ç•¶å‰ç¸½æŒè‚¡</div></div>
    `;
    
    const firstETF = Object.keys(stock.etf_holdings)[0];
    const etfData = stock.etf_holdings[firstETF];
    if (!etfData || !etfData.history) {
        document.getElementById('historyBody').innerHTML = '<tr><td colspan="6">æš«ç„¡æ­·å²æ•¸æ“š</td></tr>';
        return;
    }
    
    let html = '';
    etfData.history.forEach(record => {
        const changeClass = record.count_change > 0 ? 'positive' : record.count_change < 0 ? 'negative' : '';
        html += `<tr>
            <td>${record.date}</td>
            <td>${(record.count / 1000).toLocaleString('zh-TW', {maximumFractionDigits: 0})}K</td>
            <td>${record.weight.toFixed(2)}%</td>
            <td class="${changeClass}">${record.count_change >= 0 ? '+' : ''}${(record.count_change / 1000).toLocaleString('zh-TW', {maximumFractionDigits: 0})}K</td>
            <td class="${changeClass}">${record.weight_change >= 0 ? '+' : ''}${record.weight_change.toFixed(2)}%</td>
            <td>${record.status}</td>
        </tr>`;
    });
    document.getElementById('historyBody').innerHTML = html;
}

function backToMode() {
    if (currentMode === 'changes') {
        document.getElementById('detailPage').classList.remove('active');
        document.getElementById('changesMode').classList.remove('hidden');
    } else {
        document.getElementById('detailPage').classList.remove('active');
        document.getElementById('searchMode').classList.remove('hidden');
    }
    currentStock = null;
}

document.addEventListener('DOMContentLoaded', () => {
    Promise.all([
        fetch('./stock_history_data.json').then(r => r.json()),
        fetch('./processed_etf_data.json').then(r => r.json())
    ]).then(([sdata, pdata]) => {
        stockData = sdata;
        processedData = pdata;
        renderChanges();
        
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const filtered = Object.values(stockData).filter(stock =>
                stock.code.includes(keyword) || (stock.name && stock.name.toLowerCase().includes(keyword))
            );
            renderStockList(filtered);
        });
    }).catch(e => console.error(e));
});
</script>
</body>
</html>
