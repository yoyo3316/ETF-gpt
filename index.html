<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ETFÊåÅËÇ°ÂàÜÊûêÂπ≥Âè∞ Pro</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    /* ====== Theme & Resets ====== */
    :root {
      --primary: #667eea;
      --primary-2: #764ba2;
      --success: #27ae60;
      --danger: #e74c3c;
      --muted: #888;
      --card-border: #f0f0f0;
      --bg-grad-a: #f5f7fa;
      --bg-grad-b: #c3cfe2;
    }

    * {margin: 0; padding: 0; box-sizing: border-box;}
    body {font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg, var(--bg-grad-a) 0%, var(--bg-grad-b) 100%); color: #333; min-height: 100vh;}

    .gradient-header {background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); color: white; padding: 40px 20px; text-align: center; margin-bottom: 30px; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);}    
    .gradient-header h1 {font-size: 32px; font-weight: 700; margin-bottom: 12px;}
    .gradient-header p {font-size: 13px; opacity: 0.95; margin: 5px 0;}

    .container {max-width: 1400px; margin: 0 auto; padding: 0 20px;}

    .tabs-container {background: white; border-bottom: 3px solid var(--primary); margin-bottom: 25px; border-radius: 8px 8px 0 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);}    
    .tabs {display: flex; padding: 0;}
    .tab-btn {flex: 0 1 150px; padding: 15px 20px; background: none; border: none; cursor: pointer; color: var(--muted); font-size: 15px; border-bottom: 3px solid transparent; transition: all 0.3s;}
    .tab-btn:hover {color: #546ded;}
    .tab-btn.active {color: white; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); border-bottom-color: white;}

    .content-box {background: white; border-radius: 8px; padding: 25px; box-shadow: 0 4px 16px rgba(0,0,0,0.08);}    

    .etf-tabs {display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; flex-wrap: wrap;}
    .etf-tab {background: none; border: none; cursor: pointer; color: var(--muted); font-size: 14px; padding: 8px 15px; border-bottom: 3px solid transparent; transition: all 0.2s; font-weight: 500;}
    .etf-tab:hover {color: #546ded;}
    .etf-tab.active {color: var(--primary); border-bottom-color: var(--primary); font-weight: 600;}

    .etf-price-box {background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-radius: 12px; padding: 20px; margin-bottom: 25px; border-left: 5px solid var(--primary);}    
    .etf-price-code {font-size: 18px; font-weight: 700; color: var(--primary);}    
    .etf-price-name {font-size: 12px; color: #999; margin-top: 3px;}    
    .etf-price-value {font-size: 32px; font-weight: 700; color: #222; margin-top: 10px;}    
    .etf-price-change {font-size: 14px; margin-top: 8px; font-weight: 600;}
    .etf-price-change.negative {color: var(--danger);}    
    .etf-price-change.positive {color: #27ae60;}

    .changes-grid {display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px;}

    .change-card {background: white; border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.3s; border: 2px solid var(--card-border); box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; overflow: hidden;}
    .change-card::before {content: ''; position: absolute; top: 0; left: 0; height: 4px; width: 100%; background: linear-gradient(90deg, #546ded, var(--primary-2)); transition: height 0.3s;}
    .change-card:hover {box-shadow: 0 12px 32px rgba(84, 110, 237, 0.2); transform: translateY(-8px); border-color: var(--primary);}    
    .change-card:hover::before {height: 6px;}

    .change-card.new-add {border: 2px solid var(--success); background: linear-gradient(135deg, rgba(39,174,96,0.05) 0%, rgba(39,174,96,0.02) 100%);}    
    .change-card.new-add::before {background: linear-gradient(90deg, var(--success), #16a34a);}    
    .change-card.new-add:hover {box-shadow: 0 12px 32px rgba(39, 174, 96, 0.25); background: linear-gradient(135deg, rgba(39,174,96,0.1) 0%, rgba(39,174,96,0.05) 100%);}    

    .change-card.delete {border: 2px solid var(--danger); background: linear-gradient(135deg, rgba(231,76,60,0.05) 0%, rgba(231,76,60,0.02) 100%);}    
    .change-card.delete::before {background: linear-gradient(90deg, var(--danger), #c0392b);}    
    .change-card.delete:hover {box-shadow: 0 12px 32px rgba(231, 76, 60, 0.25); background: linear-gradient(135deg, rgba(231,76,60,0.1) 0%, rgba(231,76,60,0.05) 100%);}    

    .change-card-header {display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--card-border);}    
    .change-code-name {flex: 1;}
    .change-code {font-size: 20px; font-weight: 700; color: #222;}    
    .change-name {font-size: 13px; color: #999; margin-top: 2px; font-weight: 500;}

    .badge {display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 700;}
    .badge.new {background: linear-gradient(135deg, var(--success), #16a34a); color: white; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3); animation: pulse 2s infinite;}    
    .badge.add {background: #d1ecf1; color: #0c5460;}    
    .badge.reduce {background: #f8d7da; color: #721c24;}    
    .badge.delete {background: linear-gradient(135deg, var(--danger), #c0392b); color: white; box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3); animation: pulse 2s infinite;}    

    @keyframes pulse {0%, 100% {box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);} 50% {box-shadow: 0 4px 20px rgba(39, 174, 96, 0.6);}}

    .change-stats {display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-bottom: 14px;}
    .stat-item {background: #f9fbfc; padding: 14px; border-radius: 8px; border-left: 3px solid var(--primary);}    
    .stat-label {font-size: 11px; color: #999; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px;}    
    .stat-value {font-size: 16px; font-weight: 700; color: #222;}    
    .stat-value.positive {color: var(--success);}    
    .stat-value.negative {color: var(--danger);}    

    .search-box {margin-bottom: 20px;}
    .search-box input {width: 100%; padding: 14px 16px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; transition: all 0.2s;}
    .search-box input:focus {border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); outline: none;}

    .stocks-grid {display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 18px;}

    .stock-card {background: white; border-radius: 12px; padding: 18px; border: 2px solid var(--card-border); cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.06);}
    .stock-card:hover {box-shadow: 0 12px 32px rgba(84, 110, 237, 0.15); transform: translateY(-6px); border-color: var(--primary);}    
    .stock-card-header {margin-bottom: 14px; padding-bottom: 12px; border-bottom: 1px solid var(--card-border);}    
    .stock-code {font-size: 18px; font-weight: 700; color: var(--primary);}    
    .stock-name {font-size: 14px; color: #333; margin-top: 4px; font-weight: 500;}

    .stock-stats {display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 13px;}
    .stock-stat {background: #f9fbfc; padding: 12px; border-radius: 6px; border-left: 3px solid var(--primary);}    
    .stock-stat-label {color: #999; margin-bottom: 4px; font-size: 11px;}    
    .stock-stat-value {font-size: 15px; font-weight: 700; color: #222;}

    .hidden {display: none;}
    .detail-page {display: none;}
    .detail-page.active {display: block;}

    .back-btn {background: linear-gradient(135deg, var(--primary), var(--primary-2)); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-bottom: 20px; font-size: 14px; font-weight: 600; transition: all 0.3s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);}    
    .back-btn:hover {transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);}    

    .stock-header {background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-radius: 12px; padding: 25px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); margin-bottom: 25px; border-left: 5px solid var(--primary);}    
    .stock-title {font-size: 24px; font-weight: 700; margin-bottom: 18px; color: #222;}

    .stats-row {display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 18px; margin-bottom: 20px;}

    .stat-box {background: white; padding: 18px; border-radius: 12px; text-align: center; border: 2px solid var(--card-border); transition: all 0.2s;}
    .stat-box:hover {border-color: var(--primary); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);}    
    .stat-box-value {font-size: 24px; font-weight: 700; color: var(--primary);}    
    .stat-box-label {font-size: 12px; color: #999; margin-top: 6px; text-transform: uppercase; letter-spacing: 0.5px;}

    .chart-container {background: white; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 2px solid var(--card-border);}    
    .chart-container h3 {font-size: 16px; font-weight: 700; margin-bottom: 15px; color: #222;}

    .history-table {background: white; border-radius: 12px; overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 2px solid var(--card-border);}    
    table {width: 100%; border-collapse: collapse; min-width: 720px;}
    th {background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 14px; text-align: left; font-weight: 700; font-size: 12px; color: #333; border-bottom: 2px solid #e0e0e0; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;}
    td {padding: 14px; border-bottom: 1px solid var(--card-border); font-size: 13px; white-space: nowrap;}
    tbody tr {transition: all 0.2s;}
    tbody tr:hover {background: linear-gradient(90deg, #667eea05 0%, #764ba205 100%); box-shadow: inset 0 0 10px rgba(102, 126, 234, 0.1);}    

    .row-highlight {background: linear-gradient(90deg, rgba(39,174,96,0.1) 0%, rgba(39,174,96,0.05) 100%);}    
    .row-highlight:hover {background: linear-gradient(90deg, rgba(39,174,96,0.2) 0%, rgba(39,174,96,0.15) 100%);}    

    .row-delete {background: linear-gradient(90deg, rgba(231,76,60,0.1) 0%, rgba(231,76,60,0.05) 100%);}    
    .row-delete:hover {background: linear-gradient(90deg, rgba(231,76,60,0.2) 0%, rgba(231,76,60,0.15) 100%);}    

    .status-badge {display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;}
    .status-new {background: #d4edda; color: #155724;}
    .status-delete {background: #f8d7da; color: #721c24;}
    .status-add {background: #d1ecf1; color: #0c5460;}
    .status-reduce {background: #f8d7da; color: #721c24;}

    .no-data {color: #999; text-align: center; padding: 30px; font-size: 14px;}

    /* Loading overlay */
    .loading-overlay {position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(255,255,255,0.75); backdrop-filter: blur(2px); z-index: 9999;}
    .loading-overlay.active {display: flex;}
    .spinner {width: 44px; height: 44px; border: 4px solid #e5e7eb; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.9s linear infinite;}
    @keyframes spin {to {transform: rotate(360deg);}}

    @media (max-width: 480px) {
      .gradient-header h1 {font-size: 24px;}
      .gradient-header p {font-size: 12px;}
      .content-box {padding: 16px;}
      .etf-tab {font-size: 13px; padding: 8px 10px;}
      .stat-item {padding: 10px;}
      .stat-value {font-size: 15px;}
      .stock-title {font-size: 20px;}
      .back-btn {padding: 10px 16px; font-size: 13px;}
      .badge {padding: 6px 10px; font-size: 12px;}
      .changes-grid {grid-template-columns: 1fr !important;}
      .stocks-grid {grid-template-columns: 1fr !important;}
      #trendChart {max-height: 240px;}
    }
  </style>
</head>
<body>
  <div class="gradient-header">
    <h1>üöÄ ETFÊåÅËÇ°ÂàÜÊûêÂπ≥Âè∞ Pro</h1>
    <p id="updateTime" aria-live="polite">ÊúÄÊñ∞Êõ¥Êñ∞: --/--/--</p>
    <p>ÂØ¶ÊôÇÁï∞ÂãïÁõ£Êéß ‚Ä¢ Êô∫ËÉΩÊåÅËÇ°ÂàÜÊûê ‚Ä¢ ÂÆåÊï¥Ê≠∑Âè≤ËøΩËπ§</p>
  </div>

  <div class="container">
    <div class="tabs-container">
      <div class="tabs">
        <button class="tab-btn active" data-mode="changes" aria-controls="changesMode">üìä Áï∞ÂãïÊòéÁ¥∞</button>
        <button class="tab-btn" data-mode="search" aria-controls="searchMode">üîç ËÇ°Á•®Êü•Ë©¢</button>
      </div>
    </div>

    <!-- Áï∞ÂãïÊòéÁ¥∞Ê®°Âºè -->
    <div id="changesMode" class="content-box" role="region" aria-label="Áï∞ÂãïÊòéÁ¥∞">
      <div class="etf-tabs" id="etfTabs">
        <button class="etf-tab active" data-etf="00981A">00981A Áµ±‰∏ÄÂè∞ËÇ°Â¢ûÈï∑</button>
        <button class="etf-tab" data-etf="00980A">00980A ÈáéÊùëÊô∫ÊÖßÂÑ™ÈÅ∏</button>
        <button class="etf-tab" data-etf="00982A">00982A Áæ§ÁõäÂº∑Ê£í</button>
      </div>
      <div id="etfPriceInfo"></div>
      <div id="changesGrid" class="changes-grid"></div>
    </div>

    <!-- ËÇ°Á•®Êü•Ë©¢Ê®°Âºè -->
    <div id="searchMode" class="content-box hidden" role="region" aria-label="ËÇ°Á•®Êü•Ë©¢">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="üîé ÊêúÂ∞ãËÇ°Á•®‰ª£Á¢ºÊàñÂêçÁ®±... ‰æãÂ¶Ç: 2330„ÄÅÂè∞Á©çÈõª" aria-label="ÊêúÂ∞ãËÇ°Á•®">
      </div>
      <div class="stocks-grid" id="stocksList"></div>
    </div>

    <!-- Ë©≥Á¥∞È†ÅÈù¢ -->
    <div id="detailPage" class="detail-page" role="region" aria-label="ËÇ°Á•®Ë©≥Á¥∞">
      <button class="back-btn" id="backBtn">‚Üê ËøîÂõû</button>
      <div class="stock-header">
        <div class="stock-title" id="detailTitle"></div>
        <div class="stats-row" id="statsContainer"></div>
      </div>
      <div class="etf-tabs" id="etfTabsDetail" style="margin-bottom: 25px;"></div>
      <div class="chart-container" id="chartContainer" style="display:none;">
        <h3>üìà ÊåÅËÇ°Ë∂®Âã¢Âúñ</h3>
        <canvas id="trendChart" style="width:100%; height:auto; max-height:300px;"></canvas>
      </div>
      <div class="history-table">
        <table id="historyTable">
          <thead>
            <tr>
              <th>üìÖ Êó•Êúü</th>
              <th>üìä ÊåÅËÇ°(Âºµ)</th>
              <th>üíØ Ê¨äÈáç(%)</th>
              <th>üìà ÂºµÊï∏ËÆäÂãï</th>
              <th>üìä Ê¨äÈáçËÆäÂãï</th>
              <th>üè∑Ô∏è ÁãÄÊÖã</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loading">
    <div class="spinner" role="status" aria-label="ËºâÂÖ•‰∏≠"></div>
  </div>

  <script>
    // ====== State ======
    let stockData = {};
    let processedData = {};
    let currentETF = '00981A';
    let currentMode = 'changes';
    let currentStock = null;
    let detailETF = null;
    let trendChart = null;

    // ====== Utils ======
    const NF = new Intl.NumberFormat('zh-TW');
    const formatNumber = (num) => (num === null || num === undefined || isNaN(num)) ? '-' : NF.format(Number(num));

    function el(tag, props = {}, children = []) {
      const node = document.createElement(tag);
      Object.entries(props).forEach(([k, v]) => {
        if (k === 'className') node.className = v;
        else if (k === 'text') node.textContent = v ?? '';
        else if (k.startsWith('on') && typeof v === 'function') node.addEventListener(k.substring(2).toLowerCase(), v);
        else if (k === 'dataset' && v && typeof v === 'object') Object.entries(v).forEach(([dk, dv]) => node.dataset[dk] = dv);
        else if (v !== undefined && v !== null) node.setAttribute(k, v);
      });
      (Array.isArray(children) ? children : [children]).filter(Boolean).forEach(c => node.appendChild(c));
      return node;
    }

    function debounce(fn, wait = 250) {
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
    }

    function showLoading(yes) {
      document.getElementById('loading').classList.toggle('active', !!yes);
    }

    // ====== Mode Switching ======
    function switchMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      const changes = document.getElementById('changesMode');
      const search = document.getElementById('searchMode');
      const detail = document.getElementById('detailPage');
      if (mode === 'changes') { changes.classList.remove('hidden'); search.classList.add('hidden'); detail.classList.remove('active'); }
      else { changes.classList.add('hidden'); search.classList.remove('hidden'); detail.classList.remove('active'); renderStockList(Object.values(stockData)); }
    }

    function switchETF(code) {
      currentETF = code;
      document.querySelectorAll('.etf-tab').forEach(tab => {
        if (tab.closest('#etfTabs')) tab.classList.toggle('active', tab.dataset.etf === code);
      });
      renderChanges();
    }

    // ====== Renderers ======
    function renderETFPriceInfo(data) {
      const wrap = document.getElementById('etfPriceInfo');
      wrap.innerHTML = '';
      if (!data) return;
      const changeValue = Number(data.change_value || 0);
      const box = el('div', {className: 'etf-price-box'}, [
        el('div', {className: 'etf-price-code', text: currentETF}),
        el('div', {className: 'etf-price-name', text: data.name || ''}),
        el('div', {className: 'etf-price-value', text: `$${data.price ?? '-'}`}, []),
        el('div', {className: `etf-price-change ${changeValue < 0 ? 'negative' : 'positive'}`, text: `${changeValue >= 0 ? 'üìà ‚ñ≤' : 'üìâ ‚ñº'} ${data.change_value ?? ''} ${data.change_percent ?? ''}`})
      ]);
      wrap.appendChild(box);
    }

    function renderChanges() {
      const data = processedData[currentETF];
      renderETFPriceInfo(data);
      const grid = document.getElementById('changesGrid');
      grid.innerHTML = '';
      if (!data || !Array.isArray(data.daily_changes) || data.daily_changes.length === 0) {
        grid.appendChild(el('p', {className: 'no-data', text: '‰ªäÊó•ÁÑ°Áï∞ÂãïË≥áÊñô'}));
        return;
      }

      data.daily_changes.forEach(change => {
        const type = change.type;
        const badgeClass = type === 'Êñ∞Â¢û' ? 'new' : type === 'Â¢ûÊåÅ' ? 'add' : type === 'Ê∏õÊåÅ' ? 'reduce' : 'delete';
        const cardClass = type === 'Êñ∞Â¢û' ? 'new-add' : type === 'Âà™Èô§' ? 'delete' : '';
        const badgeIcon = type === 'Êñ∞Â¢û' ? '‚ú®' : type === 'Âà™Èô§' ? 'üóëÔ∏è' : type === 'Â¢ûÊåÅ' ? 'üìà' : 'üìâ';

        const card = el('div', {className: `change-card ${cardClass}`, role: 'button', tabindex: '0'});
        card.addEventListener('click', () => showStockDetail(change.code, currentETF));
        card.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') showStockDetail(change.code, currentETF); });

        const header = el('div', {className: 'change-card-header'}, [
          el('div', {className: 'change-code-name'}, [
            el('div', {className: 'change-code', text: change.code || ''}),
            el('div', {className: 'change-name', text: change.name || ''})
          ]),
          el('span', {className: `badge ${badgeClass}`}, [
            el('span', {className: 'badge-icon', text: badgeIcon}),
            document.createTextNode(type)
          ])
        ]);

        const stats = el('div', {className: 'change-stats'}, [
          el('div', {className: 'stat-item'}, [
            el('div', {className: 'stat-label', text: 'üíº ‰ªäÊó•ÊåÅËÇ°'}),
            el('div', {className: 'stat-value', text: formatNumber(change.current_count)})
          ]),
          el('div', {className: 'stat-item'}, [
            el('div', {className: 'stat-label', text: 'üíØ ‰ªäÊó•Ê¨äÈáç'}),
            el('div', {className: 'stat-value', text: `${Number(change.current_weight ?? 0).toFixed(2)}%`})
          ]),
          el('div', {className: 'stat-item'}, [
            el('div', {className: 'stat-label', text: 'üìä ÂºµÊï∏ËÆäÂãï'}),
            el('div', {className: `stat-value ${change.count_change > 0 ? 'positive' : 'negative'}`, text: `${change.count_change >= 0 ? '+' : ''}${formatNumber(change.count_change)}`})
          ]),
          el('div', {className: 'stat-item'}, [
            el('div', {className: 'stat-label', text: 'üìà Ê¨äÈáçËÆäÂãï'}),
            el('div', {className: `stat-value ${change.weight_change > 0 ? 'positive' : 'negative'}`, text: `${change.weight_change >= 0 ? '+' : ''}${Number(change.weight_change ?? 0).toFixed(2)}%`})
          ])
        ]);

        card.append(header, stats);
        grid.appendChild(card);
      });
    }

    function renderStockList(stocks) {
      const list = document.getElementById('stocksList');
      list.innerHTML = '';
      if (!stocks || stocks.length === 0) {
        list.appendChild(el('p', {className: 'no-data', text: 'Êö´ÁÑ°ËÇ°Á•®Êï∏Êìö'}));
        return;
      }
      stocks.slice(0, 200).forEach(stock => {
        const firstETF = Object.keys(stock.etf_holdings || {})[0];
        const etfCount = Object.keys(stock.etf_holdings || {}).length;
        const totalCount = Object.values(stock.etf_holdings || {}).reduce((sum, etf) => sum + (etf.current_count || 0), 0);

        const card = el('div', {className: 'stock-card', role: 'button', tabindex: '0'});
        card.addEventListener('click', () => showStockDetail(stock.code, firstETF));
        card.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') showStockDetail(stock.code, firstETF); });

        const head = el('div', {className: 'stock-card-header'}, [
          el('div', {className: 'stock-code', text: stock.code || ''}),
          el('div', {className: 'stock-name', text: stock.name || '(ÁÑ°ÂêçÁ®±)'})
        ]);
        const stats = el('div', {className: 'stock-stats'}, [
          el('div', {className: 'stock-stat'}, [
            el('div', {className: 'stock-stat-label', text: 'ÊåÅÊúâETF'}),
            el('div', {className: 'stock-stat-value', text: String(etfCount)})
          ]),
          el('div', {className: 'stock-stat'}, [
            el('div', {className: 'stock-stat-label', text: 'Á∏ΩÊåÅËÇ°'}),
            el('div', {className: 'stock-stat-value', text: formatNumber(totalCount)})
          ])
        ]);

        card.append(head, stats);
        list.appendChild(card);
      });
    }

    function showStockDetail(stockCode, etfCode) {
      if (!stockData[stockCode]) return;
      currentStock = stockCode;
      detailETF = etfCode;
      const stock = stockData[stockCode];

      document.getElementById('changesMode').classList.add('hidden');
      document.getElementById('searchMode').classList.add('hidden');
      document.getElementById('detailPage').classList.add('active');

      document.getElementById('detailTitle').textContent = `üìç ${stock.code} ${stock.name || ''}`;

      const etfCount = Object.keys(stock.etf_holdings).length;
      const totalCount = Object.values(stock.etf_holdings).reduce((sum, etf) => sum + (etf.current_count || 0), 0);
      const maxCount = Math.max(0, ...Object.values(stock.etf_holdings).map(e => e.max_count || 0));
      const finiteMins = Object.values(stock.etf_holdings).map(e => e.min_count).filter(v => Number.isFinite(v));
      const minCount = finiteMins.length ? Math.min(...finiteMins) : 0;

      document.getElementById('statsContainer').innerHTML = '';
      document.getElementById('statsContainer').append(
        el('div', {className: 'stat-box'}, [el('div', {className: 'stat-box-value', text: String(etfCount)}), el('div', {className: 'stat-box-label', text: 'ÊåÅÊúâETF'})]),
        el('div', {className: 'stat-box'}, [el('div', {className: 'stat-box-value', text: formatNumber(totalCount)}), el('div', {className: 'stat-box-label', text: 'Áï∂ÂâçÁ∏ΩÊåÅËÇ°'})]),
        el('div', {className: 'stat-box'}, [el('div', {className: 'stat-box-value', text: formatNumber(maxCount)}), el('div', {className: 'stat-box-label', text: 'ÊúÄÈ´òÊåÅËÇ°'})]),
        el('div', {className: 'stat-box'}, [el('div', {className: 'stat-box-value', text: formatNumber(minCount)}), el('div', {className: 'stat-box-label', text: 'ÊúÄ‰ΩéÊåÅËÇ°'})])
      );

      const tabsDetail = document.getElementById('etfTabsDetail');
      tabsDetail.innerHTML = '';
      Object.entries(stock.etf_holdings).forEach(([code, etfData]) => {
        const btn = el('button', {className: 'etf-tab' + (detailETF === code ? ' active' : ''), dataset: {etf: code}}, [document.createTextNode(`${code} ${etfData.etf_name}`)]);
        btn.addEventListener('click', () => switchDetailETF(code));
        tabsDetail.appendChild(btn);
      });

      renderHistoryTable(etfCode);
    }

    function switchDetailETF(etfCode) {
      detailETF = etfCode;
      document.querySelectorAll('#etfTabsDetail .etf-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.etf === etfCode);
      });
      renderHistoryTable(etfCode);
    }

    function renderHistoryTable(etfCode) {
      const stock = stockData[currentStock];
      const etfData = stock?.etf_holdings?.[etfCode];
      const body = document.getElementById('historyBody');

      if (!etfData || !Array.isArray(etfData.history) || etfData.history.length === 0) {
        body.innerHTML = '';
        body.appendChild(el('tr', {}, [el('td', {colspan: '6', className: 'no-data', text: 'Êö´ÁÑ°Ê≠∑Âè≤Êï∏Êìö'})]));
        document.getElementById('chartContainer').style.display = 'none';
        return;
      }

      const sortedHistory = [...etfData.history].sort((a, b) => new Date(b.date.replace(/\//g, '-')) - new Date(a.date.replace(/\//g, '-')));
      drawTrendChart(sortedHistory);

      body.innerHTML = '';
      sortedHistory.forEach(record => {
        const changeClass = record.count_change > 0 ? 'positive' : record.count_change < 0 ? 'negative' : '';
        const rowClass = record.status === 'Âá∫Ê∏Ö' ? 'row-delete' : record.status === 'È¶ñÊ¨°Âá∫Áèæ' ? 'row-highlight' : '';
        const countStr = record.count_change >= 0 ? '+' : '';
        const weightStr = record.weight_change >= 0 ? '+' : '';
        const statusKey = record.status === 'Âá∫Ê∏Ö' ? 'delete' : record.status === 'È¶ñÊ¨°Âá∫Áèæ' ? 'new' : record.status === 'Â¢ûÊåÅ' ? 'add' : 'reduce';

        const tr = el('tr', {className: rowClass});
        tr.append(
          el('td', {text: record.date}),
          el('td', {}, [el('strong', {text: formatNumber(record.count)})]),
          el('td', {text: `${Number(record.weight ?? 0).toFixed(2)}%`}),
          el('td', {className: changeClass}, [el('strong', {text: `${countStr}${formatNumber(record.count_change)}`})]),
          el('td', {className: changeClass}, [el('strong', {text: `${weightStr}${Number(record.weight_change ?? 0).toFixed(2)}%`})]),
          el('td', {}, [el('span', {className: `status-badge status-${statusKey}`, text: record.status})])
        );
        body.appendChild(tr);
      });
    }

    function drawTrendChart(history) {
      const chartContainer = document.getElementById('chartContainer');
      chartContainer.style.display = 'block';

      const sortedHistory = [...history].sort((a, b) => new Date(a.date.replace(/\//g, '-')) - new Date(b.date.replace(/\//g, '-')));
      const labels = sortedHistory.map(h => h.date);
      const counts = sortedHistory.map(h => h.count);

      const ctx = document.getElementById('trendChart').getContext('2d');
      if (trendChart) trendChart.destroy();

      trendChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{
          label: 'ÊåÅËÇ°ÂºµÊï∏', data: counts,
          borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.08)', borderWidth: 2,
          fill: true, tension: 0.3, pointRadius: counts.length > 200 ? 0 : 3,
          pointBackgroundColor: '#667eea', pointBorderColor: 'white', pointBorderWidth: 2,
        }]},
        options: {
          responsive: true, maintainAspectRatio: true, animation: false,
          plugins: { legend: { display: false }, decimation: { enabled: true, algorithm: 'lttb', samples: 200 } },
          scales: { y: { beginAtZero: false, grid: { color: 'rgba(0,0,0,0.05)' } } },
        }
      });
    }

    function backToMode() {
      const detail = document.getElementById('detailPage');
      if (currentMode === 'changes') {
        detail.classList.remove('active');
        document.getElementById('changesMode').classList.remove('hidden');
      } else {
        detail.classList.remove('active');
        document.getElementById('searchMode').classList.remove('hidden');
      }
      currentStock = null;
      detailETF = null;
    }

    // ====== Data Load (with cache) ======
    async function loadData() {
      showLoading(true);
      try {
        const cacheKey = 'etf_platform_cache_v1';
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
          const obj = JSON.parse(cached);
          const age = Date.now() - obj.__ts;
          if (age < 5 * 60 * 1000) { // 5 ÂàÜÈêòÂø´Âèñ
            processedData = obj.pdata; stockData = obj.sdata; initAfterLoad(); showLoading(false); return;
          }
        }

        const [pResp, sResp] = await Promise.all([
          fetch('./processed_etf_data.json', {cache: 'no-cache'}),
          fetch('./stock_history_data.json', {cache: 'no-cache'})
        ]);
        if (!pResp.ok || !sResp.ok) throw new Error('Ë≥áÊñôÊ™îÊ°àÂõûÂÇ≥Èùû 200');
        const [pdata, sdata] = await Promise.all([pResp.json(), sResp.json()]);
        processedData = pdata; stockData = sdata;
        localStorage.setItem(cacheKey, JSON.stringify({__ts: Date.now(), pdata, sdata}));
        initAfterLoad();
      } catch (e) {
        console.error('ËºâÂÖ•ÈåØË™§:', e);
        alert('ÁÑ°Ê≥ïËºâÂÖ•Ë≥áÊñôÊ™îÊ°àÔºåË´ãÁ¢∫‰øù processed_etf_data.json Âíå stock_history_data.json Âú®ÂêåÁõÆÈåÑ');
      } finally {
        showLoading(false);
      }
    }

    function initAfterLoad() {
      const firstKey = Object.keys(processedData)[0];
      const first = processedData[firstKey];
      if (first && first.latest_date) {
        document.getElementById('updateTime').textContent = 'ÊúÄÊñ∞Êõ¥Êñ∞: ' + first.latest_date;
      }
      renderChanges();
    }

    // ====== Event Bindings ======
    document.addEventListener('DOMContentLoaded', () => {
      // Top tabs
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchMode(btn.dataset.mode));
      });
      // ETF tabs (changesMode)
      document.getElementById('etfTabs').addEventListener('click', (e) => {
        const t = e.target.closest('.etf-tab');
        if (t && t.dataset.etf) switchETF(t.dataset.etf);
      });
      // Back
      document.getElementById('backBtn').addEventListener('click', backToMode);

      // Search with debounce
      const searchEl = document.getElementById('searchInput');
      searchEl.addEventListener('input', debounce((e) => {
        const keyword = e.target.value.trim().toLowerCase();
        const filtered = Object.values(stockData).filter(stock => {
          const code = (stock.code || '').toString().toLowerCase();
          const name = (stock.name || '').toLowerCase();
          return code.includes(keyword) || name.includes(keyword);
        });
        renderStockList(filtered);
      }, 200));

      // Load data
      loadData();
    });
  </script>
</body>
</html>
